<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<title>Modern Kilit Simülasyonu</title>
<style>
  :root {
    --pin-w: 45px;
    --pin-h: 180px;
    --shear-y: 108px;
    --main-bg: #1a1a2e;
    --lock-bg: #c49355;
    --pin-color: #3f3f5f;
    --pin-border: #2a2a2a;
    --key-pin: #ff4040;
    --driver-pin: #2176ff;
    --spring-color: #666;
    --success-color: #00ff9d;
    --error-color: #ff4757;
    touch-action: none;
  }

  * {
    box-sizing: border-box;
    margin: 0;
    padding: 0;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
  }

  body {
    background: var(--main-bg);
    color: #fff;
    font-family: 'Segoe UI', sans-serif;
    min-height: 100vh;
    min-height: -webkit-fill-available;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    gap: 20px;
    overscroll-behavior: none;
  }

  html {
    height: -webkit-fill-available;
    overscroll-behavior: none;
  }

  .game-container {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    touch-action: none;
  }

  .game-title {
    font-size: 2.5em;
    font-weight: 700;
    color: #fff;
    margin-bottom: 20px;
    letter-spacing: 2px;
  }

  .indicators {
    display: flex;
    gap: 15px;
    margin-bottom: 15px;
    justify-content: center;
    align-items: center;
  }

  .dot {
    width: 32px;
    height: 32px;
    border-radius: 50%;
    background: #ff4757;
    box-shadow: 0 0 10px rgba(255,71,87,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 16px;
    font-weight: 700;
    color: #000;
    transition: all 0.3s ease;
  }

  .dot.ok {
    background: var(--success-color);
    box-shadow: 0 0 15px rgba(0,255,157,0.3);
  }

  .dot.warning {
    color: #ff0000;
  }

  .lock {
    position: relative;
    display: flex;
    gap: 10px;
    background: linear-gradient(145deg, var(--lock-bg), #a67a45);
    padding: 40px 30px;
    border-radius: 12px;
    box-shadow: 
      inset 0 0 30px rgba(0,0,0,0.3),
      0 10px 20px rgba(0,0,0,0.2);
    transform: rotateX(12deg);
    transform-style: preserve-3d;
    perspective: 1000px;
    touch-action: none;
    -webkit-user-select: none;
    user-select: none;
  }

  .pin {
    width: var(--pin-w);
    height: var(--pin-h);
    background: linear-gradient(to right, #333, #444, #333);
    border: 2px solid var(--pin-border);
    border-radius: 8px;
    overflow: hidden;
    position: relative;
    transition: transform 0.2s ease;
    cursor: pointer;
    box-shadow: 
      inset 0 0 10px rgba(0,0,0,0.3),
      0 2px 5px rgba(0,0,0,0.2);
  }

  .pin:hover {
    transform: translateY(-2px);
  }

  .pin:active {
    transform: translateY(0);
  }

  /* Yay görünümü */
  .spring {
    position: absolute;
    top: 0;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 40px;
    background: repeating-linear-gradient(
      0deg,
      var(--spring-color),
      var(--spring-color) 2px,
      transparent 2px,
      transparent 6px
    );
    opacity: 0.7;
  }

  /* Sürücü pin (mavi) */
  .drv {
    position: absolute;
    left: 0;
    width: 100%;
    height: 30px;
    background: var(--driver-pin);
    border-top: 2px solid rgba(0,0,0,0.2);
    border-bottom: 2px solid rgba(0,0,0,0.2);
    transition: all 0.15s ease;
    box-shadow: 
      inset 0 2px 3px rgba(255,255,255,0.2),
      inset 0 -2px 3px rgba(0,0,0,0.2);
  }

  /* Kilit pini (kırmızı) */
  .alt {
    position: absolute;
    left: 0;
    width: 100%;
    background: var(--key-pin);
    border-top: 2px solid rgba(0,0,0,0.2);
    border-bottom: 2px solid rgba(0,0,0,0.2);
    transition: all 0.15s ease;
    box-shadow: 
      inset 0 2px 3px rgba(255,255,255,0.2),
      inset 0 -2px 3px rgba(0,0,0,0.2);
  }

  /* Pin-specific heights */
  #a0 { height: 45px; }
  #a1 { height: 35px; }
  #a2 { height: 50px; }
  #a3 { height: 40px; }
  #a4 { height: 30px; }

  /* Kilit çizgisi */
  .lock::before {
    content: "";
    position: absolute;
    left: -15px;
    top: 50%;
    width: 20px;
    height: 50px;
    background: linear-gradient(to left, var(--lock-bg), #8b5e2e);
    transform: translateY(-50%);
    border-radius: 5px 0 0 5px;
    box-shadow: inset 2px 0 5px rgba(0,0,0,0.2);
    z-index: 1;
  }

  /* Kilit gövdesi detayları */
  .lock-body {
    position: absolute;
    bottom: -20px;
    left: -10px;
    right: -10px;
    height: 40px;
    background: linear-gradient(to bottom, var(--lock-bg), #8b5e2e);
    border-radius: 0 0 12px 12px;
    box-shadow: 
      inset 0 2px 5px rgba(255,255,255,0.2),
      0 2px 5px rgba(0,0,0,0.2);
  }

  /* Anahtar deliği */
  .keyhole {
    position: absolute;
    bottom: -10px;
    left: 50%;
    transform: translateX(-50%);
    width: 20px;
    height: 30px;
    background: #222;
    border-radius: 4px;
    box-shadow: inset 0 0 5px rgba(0,0,0,0.8);
  }

  /* Lock picking tools */
  .lock-tools {
    position: absolute;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 10;
  }

  .pick-tool {
    position: absolute;
    width: 160px;
    height: 3px;
    background: #666;
    bottom: 50%;
    left: -190px;
    transform-origin: right center;
    transform: rotate(0deg);
    transition: transform 0.15s ease;
  }

  .pick-tool.picking {
    animation: pickMove 0.15s ease-in-out;
  }

  @keyframes pickMove {
    0%, 100% { transform: rotate(0deg) translateY(0); }
    50% { transform: rotate(0deg) translateY(2px); }
  }

  .tension-tool {
    position: absolute;
    width: 140px;
    height: 3px;
    background: #666;
    bottom: calc(50% - 10px);
    left: -175px;
    transform-origin: right center;
    transform: rotate(-65deg);
    transition: transform 0.5s ease;
  }

  .tension-tool.turning {
    transform: rotate(-110deg);
  }

  /* Kilit gövdesi yan çıkıntısı */
  .lock::after {
    content: "";
    position: absolute;
    right: -12px;
    top: 50%;
    width: 15px;
    height: 35px;
    background: linear-gradient(to right, var(--lock-bg), #8b5e2e);
    transform: translateY(-50%);
    border-radius: 0 5px 5px 0;
    box-shadow: inset -2px 0 5px rgba(0,0,0,0.2);
  }

  .lock-controls {
    position: relative;
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-top: 40px;
  }

  .direction-controls {
    display: flex;
    gap: 20px;
    justify-content: center;
    align-items: center;
    margin-bottom: 30px;
  }

  .control-btn {
    width: 65px;
    height: 65px;
    border: none;
    border-radius: 15px;
    background: linear-gradient(145deg, #323260, #1e1e3d);
    color: #fff;
    font-size: 28px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 
      5px 5px 10px rgba(0,0,0,0.3),
      -5px -5px 10px rgba(255,255,255,0.05);
  }

  .control-btn:hover {
    background: linear-gradient(145deg, #3a3a6e, #252548);
    transform: translateY(-2px);
    box-shadow: 
      8px 8px 15px rgba(0,0,0,0.3),
      -8px -8px 15px rgba(255,255,255,0.05);
  }

  .control-btn:active {
    transform: translateY(0);
    background: linear-gradient(145deg, #1e1e3d, #323260);
    box-shadow: 
      inset 5px 5px 10px rgba(0,0,0,0.3),
      inset -5px -5px 10px rgba(255,255,255,0.05);
  }

  .tension-control {
    position: absolute;
    left: -120px;
    top: 0;
  }

  .tension-btn {
    width: 70px;
    height: 70px;
    border: none;
    border-radius: 50%;
    background: linear-gradient(145deg, #ff5555, #e63939);
    color: #fff;
    font-size: 26px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 
      5px 5px 10px rgba(0,0,0,0.3),
      -5px -5px 10px rgba(255,255,255,0.1);
  }

  .tension-btn:hover {
    background: linear-gradient(145deg, #ff6666, #ff4040);
    transform: scale(1.1);
    box-shadow: 
      8px 8px 15px rgba(0,0,0,0.3),
      -8px -8px 15px rgba(255,255,255,0.1);
  }

  .tension-btn:active {
    transform: scale(1);
    background: linear-gradient(145deg, #e63939, #ff5555);
    box-shadow: 
      inset 5px 5px 10px rgba(0,0,0,0.3),
      inset -5px -5px 10px rgba(255,255,255,0.1);
  }

  .tension-btn:disabled {
    background: linear-gradient(145deg, #777, #555);
    cursor: not-allowed;
    transform: scale(1);
    opacity: 0.7;
    box-shadow: none;
  }

  .reset-container {
    position: absolute;
    right: 0;
    top: 95px;
  }

  .reset-btn {
    width: 65px;
    height: 65px;
    border: none;
    border-radius: 15px;
    background: linear-gradient(145deg, #323260, #1e1e3d);
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 
      5px 5px 10px rgba(0,0,0,0.3),
      -5px -5px 10px rgba(255,255,255,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 0;
    line-height: 1;
    text-align: center;
  }

  .reset-btn:hover {
    background: linear-gradient(145deg, #3a3a6e, #252548);
    transform: translateY(-2px);
    box-shadow: 
      8px 8px 15px rgba(0,0,0,0.3),
      -8px -8px 15px rgba(255,255,255,0.05);
  }

  .reset-btn:active {
    transform: translateY(0);
    background: linear-gradient(145deg, #1e1e3d, #323260);
    box-shadow: 
      inset 5px 5px 10px rgba(0,0,0,0.3),
      inset -5px -5px 10px rgba(255,255,255,0.05);
  }

  .active-pin {
    border: 2px solid var(--success-color) !important;
    box-shadow: 0 0 15px rgba(0,255,157,0.3) !important;
  }

  .controls {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    margin-top: 20px;
  }

  button {
    padding: 12px 35px;
    border: none;
    border-radius: 12px;
    background: linear-gradient(145deg, #323260, #1e1e3d);
    color: #fff;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 
      5px 5px 10px rgba(0,0,0,0.3),
      -5px -5px 10px rgba(255,255,255,0.05);
  }

  button:hover {
    background: linear-gradient(145deg, #3a3a6e, #252548);
    transform: translateY(-2px);
    box-shadow: 
      8px 8px 15px rgba(0,0,0,0.3),
      -8px -8px 15px rgba(255,255,255,0.05);
  }

  button:active {
    transform: translateY(0);
    background: linear-gradient(145deg, #1e1e3d, #323260);
    box-shadow: 
      inset 5px 5px 10px rgba(0,0,0,0.3),
      inset -5px -5px 10px rgba(255,255,255,0.05);
  }

  #status {
    font-size: 1.1em;
    color: rgba(255,255,255,0.9);
    text-align: center;
  }

  #openBanner {
    font-size: 24px;
    font-weight: 700;
    color: var(--success-color);
    text-shadow: 0 0 10px rgba(0,255,157,0.3);
    display: none;
  }

  @media (max-width: 600px) {
    .game-title { font-size: 2em; }
    .lock { padding: 30px 20px; }
    :root {
      --pin-w: 40px;
      --pin-h: 120px;
    }
    .dot {
      width: 28px;
      height: 28px;
      font-size: 14px;
    }
    .control-btn {
      width: 70px;
      height: 70px;
      font-size: 30px;
    }
    .tension-btn {
      width: 75px;
      height: 75px;
      font-size: 28px;
    }
    .lock-controls {
      margin-top: 50px;
    }
    .direction-controls {
      gap: 25px;
      margin-bottom: 35px;
    }
    .reset-btn {
      width: 70px;
      height: 70px;
      font-size: 15px;
    }
    .tension-control {
      left: -130px;
    }
    .reset-container {
      right: 0;
      top: 105px;
    }
  }

  /* Lightbox Stili */
  .lightbox-container {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    z-index: 1000;
    overflow: hidden;
  }

  .lightbox-content {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
  }

  .lightbox-image-container {
    position: relative;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
    overflow: hidden;
    touch-action: none;
  }

  .lightbox-image {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
    transform-origin: center;
    transition: transform 0.2s ease-out;
    touch-action: none;
    will-change: transform;
  }

  .popup-images {
    display: none;
    position: fixed;
    bottom: 20px;
    right: 20px;
    gap: 10px;
    z-index: 999;
  }

  .popup-image {
    width: 150px;
    height: 100px;
    object-fit: cover;
    cursor: pointer;
    border: 2px solid white;
    border-radius: 5px;
    transition: transform 0.3s;
  }

  .popup-image:hover {
    transform: scale(1.1);
  }

  .lightbox-nav {
    position: fixed;
    top: 50%;
    transform: translateY(-50%);
    width: 100%;
    display: flex;
    justify-content: space-between;
    padding: 0 20px;
    pointer-events: none;
    z-index: 1002;
  }

  .nav-button {
    pointer-events: auto;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 25px;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
  }

  .nav-button:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  .close-button {
    position: fixed;
    top: 20px;
    right: 20px;
    background: rgba(0, 0, 0, 0.5);
    color: white;
    border: none;
    width: 50px;
    height: 50px;
    border-radius: 25px;
    font-size: 28px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s ease;
    z-index: 1002;
  }

  .close-button:hover {
    background: rgba(0, 0, 0, 0.8);
  }

  @media (max-width: 600px) {
    .nav-button, .close-button {
      width: 44px;
      height: 44px;
      font-size: 20px;
    }
    
    .close-button {
      top: 10px;
      right: 10px;
    }
  }
</style>
</head>
<body>
  <div class="background"></div>
  
  <div class="game-container">
    <div class="indicators">
      <div class="dot" id="dot0"></div>
      <div class="dot" id="dot1"></div>
      <div class="dot" id="dot2"></div>
      <div class="dot" id="dot3"></div>
      <div class="dot" id="dot4"></div>
    </div>

    <div class="lock" id="lock">
      <div class="pin" id="pin0">
        <div class="spring"></div>
        <div class="alt" id="a0"></div>
        <div class="drv" id="d0"></div>
      </div>
      <div class="pin" id="pin1">
        <div class="spring"></div>
        <div class="alt" id="a1"></div>
        <div class="drv" id="d1"></div>
      </div>
      <div class="pin" id="pin2">
        <div class="spring"></div>
        <div class="alt" id="a2"></div>
        <div class="drv" id="d2"></div>
      </div>
      <div class="pin" id="pin3">
        <div class="spring"></div>
        <div class="alt" id="a3"></div>
        <div class="drv" id="d3"></div>
      </div>
      <div class="pin" id="pin4">
        <div class="spring"></div>
        <div class="alt" id="a4"></div>
        <div class="drv" id="d4"></div>
      </div>
      <div class="lock-body">
        <div class="keyhole"></div>
      </div>
      <div class="lock-tools">
        <div class="tension-tool" id="tensionTool"></div>
        <div class="pick-tool" id="pickTool"></div>
      </div>
    </div>

    <div class="lock-controls">
      <div class="direction-controls">
        <button class="control-btn left">⬅️</button>
        <button class="control-btn up">⬆️</button>
        <button class="control-btn right">➡️</button>
      </div>
      <div class="tension-control">
        <button class="tension-btn" id="tensionBtn">🔄</button>
      </div>
      <div class="reset-container">
        <button class="reset-btn" onclick="resetPins()">Sıfırla</button>
      </div>
    </div>
  </div>
  
  <div id="openBanner">✨ KİLİT AÇILDI! ✨</div>

  <!-- Ses Efektleri -->
  <!-- 1. Pin doğru hizaya geldiğinde -->
  <audio id="clickSound" preload="auto">
    <source src="https://www.soundjay.com/mechanical/sounds/lock-mechanism-1.mp3" type="audio/mpeg">
  </audio>
  
  <!-- 2. Pin düştüğünde -->
  <audio id="dropSound" preload="auto">
    <source src="https://www.soundjay.com/mechanical/sounds/pin-drop-1.mp3" type="audio/mpeg">
  </audio>
  
  <!-- 3. Kilit açıldığında -->
  <audio id="unlockSound" preload="auto">
    <source src="https://www.soundjay.com/mechanical/sounds/door-unlock-1.mp3" type="audio/mpeg">
  </audio>

  <!-- Lightbox -->
  <div class="lightbox-container" id="lightbox">
    <button class="close-button" id="closeButton">×</button>
    <div class="lightbox-content">
      <div class="lightbox-image-container">
        <img src="" alt="Kilit Görüntüsü" class="lightbox-image" id="lightboxImage">
      </div>
      <div class="lightbox-nav">
        <button class="nav-button" id="prevButton">←</button>
        <button class="nav-button" id="nextButton">→</button>
      </div>
    </div>
  </div>

  <!-- Pop-up Görüntüler -->
  <div class="popup-images" id="popupImages">
    <img src="https://images.unsplash.com/photo-1517420879524-86d64ac2f339?w=500" alt="Kilit 1" class="popup-image" data-index="0">
    <img src="https://images.unsplash.com/photo-1503792501406-2c40da09e1e2?w=500" alt="Kilit 2" class="popup-image" data-index="1">
  </div>

<script>
/* === Ayarlar === */
const pinCount = 5;
const pinH = 180;
const baseline = 10;
const step = 5;
const tol = 2;
const hold = 20000;

// Pin yükseklikleri
const altHeights = [45, 35, 50, 40, 30];

/* shear‑line pin koordinatı */
const padTop = parseInt(getComputedStyle(document.getElementById("lock")).paddingTop);
const shearPin = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--shear-y')) - padTop;

// Her pin için hedef pozisyonlar hesaplanıyor - ortaya yakın bir noktada hizalanacak şekilde
const target = altHeights.map(h => Math.floor(pinH * 0.6) - h); // Hizalanma noktasını aşağıya çektik

/* === Dinamik === */
const pos = Array(pinCount).fill(baseline);
const timers = Array(pinCount).fill(null);
const expire = Array(pinCount).fill(null);
const locked = Array(pinCount).fill(false);
const lastClickTime = Array(pinCount).fill(0);
const overflowCounter = Array(pinCount).fill(0); // Hiza aşımı sayacı
const OVERFLOW_LIMIT = 3; // 3 tıklamada düşecek
let opened = false;
let currentPin = 0;

// İnaktivite kontrolü için timer
let inactivityTimer = null;
const INACTIVITY_TIMEOUT = 2000; // 2 saniye

const st = document.getElementById("status");
const bn = document.getElementById("openBanner");
const clickSound = document.getElementById("clickSound");
const tensionBtn = document.getElementById("tensionBtn");
const pickTool = document.getElementById("pickTool");
const tensionTool = document.getElementById("tensionTool");

const dot = i => document.getElementById(`dot${i}`);
const alt = i => document.getElementById(`a${i}`);
const drv = i => document.getElementById(`d${i}`);
const pin = i => document.getElementById(`pin${i}`);

// Pin pozisyonlarını hesapla
const pinPositions = [];
for(let i=0; i<pinCount; i++) {
  const pinElement = document.getElementById(`pin${i}`);
  const rect = pinElement.getBoundingClientRect();
  const lockRect = document.querySelector('.lock').getBoundingClientRect();
  pinPositions[i] = {
    x: rect.left - lockRect.left + rect.width / 2,
    y: rect.bottom - lockRect.bottom
  };
}

// Pick aletini hareket ettir
function movePick(pinIndex) {
  const position = pinPositions[pinIndex];
  if(position) {
    // Pick sadece yukarı/aşağı hareket edecek, sağa/sola hareket etmeyecek
    pickTool.style.transform = `rotate(-10deg)`;
  }
}

// Pick animasyonu - sadece yukarı/aşağı hareket
function animatePick() {
  pickTool.classList.add('picking');
  setTimeout(() => {
    pickTool.classList.remove('picking');
  }, 150);
}

function draw(i) {
  alt(i).style.bottom = pos[i] + "px";
  drv(i).style.bottom = (pos[i] + altHeights[i]) + "px";
}

/* Başlat */
for(let i=0; i<pinCount; i++) {
  alt(i).style.height = altHeights[i] + "px";
  draw(i);
}
updateActivePin();
addEvents();
startTick();
startInactivityCheck();

/* === Ses Efektleri === */
/*
 * Ses Efektleri:
 * 1. clickSound: Bir pin doğru hizaya geldiğinde çalar
 * 2. dropSound: Bir pin süre dolunca düştüğünde çalar
 * 3. unlockSound: Kilit açıldığında çalar
 */
function playSound(soundId) {
  const sound = document.getElementById(soundId);
  
  // Ses çalma denemesi
  const playPromise = sound.play();
  
  if (playPromise !== undefined) {
    playPromise
      .then(() => {
        // Ses başarıyla çalındı
        if(!sound.paused) {
          sound.currentTime = 0;
        }
      })
      .catch(error => {
        console.log("Ses çalma hatası:", error);
        // Kullanıcı etkileşimi gerekiyorsa bir kerelik ses izni isteyelim
        if (error.name === "NotAllowedError") {
          document.addEventListener('click', function initAudio() {
            sound.play().then(() => {
              document.removeEventListener('click', initAudio);
            });
          });
        }
      });
  }
}

/* === Mekanik === */
function move(i) {
  if(opened) return;
  pos[i] += step;
  draw(i);
  
  // Son tıklama zamanını güncelle
  lastClickTime[i] = Date.now();
  
  // Kilit pini ve sürücü pinin pozisyonunu kontrol et
  const pinPosition = pos[i] + altHeights[i];
  const targetPosition = pinH - shearPin;
  const diff = Math.abs(pinPosition - targetPosition);
  
  if(!locked[i]) {
    if(diff <= tol) {
      lock(i);
    } else if(pos[i] > target[i] + tol) {
      // Hiza aşıldığında sayacı artır
      overflowCounter[i]++;
      if(overflowCounter[i] >= OVERFLOW_LIMIT) {
        drop(i);
      }
    }
  } else if(diff > tol) {
    drop(i);
  }
}

function lock(i) {
  locked[i] = true;
  dot(i).classList.add("ok");
  playSound('clickSound');  // Pin doğru hizaya geldiğinde
  expire[i] = Date.now() + hold;
  timers[i] = setTimeout(() => drop(i), hold);
  
  if(locked.every(v => v)) {
    tensionBtn.disabled = false;
  }
}

function drop(i) {
  if(opened) return;
  if(timers[i]) {
    clearTimeout(timers[i]);
    timers[i] = null;
  }
  locked[i] = false;
  expire[i] = null;
  pos[i] = baseline;
  overflowCounter[i] = 0;
  draw(i);
  dot(i).classList.remove("ok");
  dot(i).textContent = "";
  playSound('dropSound');
  tensionBtn.disabled = true;
}

function freezeAll() {
  for(let i=0; i<pinCount; i++) {
    if(timers[i]) {
      clearTimeout(timers[i]);
      timers[i] = null;
    }
    dot(i).textContent = "";
  }
  document.querySelector('.lock').style.boxShadow = `
    inset 0 0 30px rgba(0,255,157,0.2),
    0 10px 20px rgba(0,0,0,0.2)
  `;
  tensionTool.classList.add('turning');
  playSound('unlockSound');
  
  // Görüntüleri göster
  togglePopupImages(true);
  
  // İlk görüntüyü otomatik olarak lightbox'ta göster
  setTimeout(() => {
    showLightbox(0);
  }, 500);
}

function updateActivePin() {
  // Önceki aktif pini temizle
  for(let i=0; i<pinCount; i++) {
    pin(i).classList.remove('active-pin');
  }
  // Yeni aktif pini işaretle
  pin(currentPin).classList.add('active-pin');
}

/* === Sayaç === */
function startTick() {
  setInterval(() => {
    if(opened) return;
    const now = Date.now();
    for(let i=0; i<pinCount; i++) {
      if(locked[i] && expire[i]) {
        let s = Math.ceil((expire[i]-now)/1000);
        dot(i).textContent = s<=0 ? "" : s;
        // Son 5 saniye için kırmızı renk
        if(s <= 5 && s > 0) {
          dot(i).classList.add('warning');
        } else {
          dot(i).classList.remove('warning');
        }
      } else {
        dot(i).textContent = "";
        dot(i).classList.remove('warning');
      }
    }
  }, 1000);
}

/* === Reset === */
function resetPins() {
  if(inactivityTimer) clearInterval(inactivityTimer);
  for(let i=0; i<pinCount; i++) {
    if(timers[i]) clearTimeout(timers[i]);
    timers[i] = null;
    locked[i] = false;
    expire[i] = null;
    pos[i] = baseline;
    lastClickTime[i] = 0;
    overflowCounter[i] = 0; // Sayacı sıfırla
    draw(i);
    dot(i).classList.remove("ok");
    dot(i).textContent = "";
    pin(i).classList.remove('active-pin');
  }
  opened = false;
  currentPin = 0;
  updateActivePin();
  movePick(currentPin);
  st.style.display = "block";
  st.textContent = "📌 Pimleri hizalayarak kilidi açmayı dene";
  st.style.color = 'rgba(255,255,255,0.9)';
  bn.style.display = "none";
  tensionBtn.disabled = true;
  tensionTool.classList.remove('turning');
  document.querySelector('.lock').style.background = 'linear-gradient(145deg, var(--lock-bg), #a67a45)';
  document.querySelector('.lock-body').style.background = 'linear-gradient(to bottom, var(--lock-bg), #8b5e2e)';
  document.querySelector('.lock').style.boxShadow = `
    inset 0 0 30px rgba(0,0,0,0.3),
    0 10px 20px rgba(0,0,0,0.2)
  `;
  startInactivityCheck(); // İnaktivite kontrolünü başlat
  togglePopupImages(false);
}

/* === Etkileşim === */
function addEvents() {
  const leftBtn = document.querySelector('.control-btn.left');
  const rightBtn = document.querySelector('.control-btn.right');
  const upBtn = document.querySelector('.control-btn.up');
  
  leftBtn.onclick = () => {
    currentPin = (currentPin - 1 + pinCount) % pinCount;
    updateActivePin();
    movePick(currentPin);
  };
  
  rightBtn.onclick = () => {
    currentPin = (currentPin + 1) % pinCount;
    updateActivePin();
    movePick(currentPin);
  };
  
  upBtn.onclick = () => {
    move(currentPin);
    animatePick();
  };
  
  tensionBtn.onclick = () => {
    if(locked.every(v => v) && !opened) {
      opened = true;
      freezeAll();
      document.querySelector('.lock').style.background = 'linear-gradient(145deg, #d4a365, #b68355)';
      document.querySelector('.lock-body').style.background = 'linear-gradient(to bottom, #d4a365, #9b6e3e)';
      tensionBtn.disabled = true;
    }
  };
  
  // Klavye kontrolleri
  document.addEventListener('keydown', (e) => {
    if(opened) return;
    
    switch(e.key) {
      case 'ArrowLeft':
        leftBtn.click();
        break;
      case 'ArrowRight':
        rightBtn.click();
        break;
      case 'ArrowUp':
      case ' ':
        upBtn.click();
        break;
      case 'Enter':
        if(!tensionBtn.disabled) {
          tensionBtn.click();
        }
        break;
    }
  });

  // İlk pick pozisyonu
  movePick(currentPin);
}

function checkInactivity() {
  const now = Date.now();
  for(let i=0; i<pinCount; i++) {
    // Kilitli olmayan ve yükseltilmiş pimleri kontrol et
    if(!locked[i] && pos[i] > baseline) {
      // Son tıklamadan bu yana geçen süre
      if(now - lastClickTime[i] >= INACTIVITY_TIMEOUT) {
        drop(i);
      }
    }
  }
}

function startInactivityCheck() {
  if(inactivityTimer) clearInterval(inactivityTimer);
  inactivityTimer = setInterval(checkInactivity, 500); // Her yarım saniyede kontrol et
}

// Lightbox ve görüntü kontrolü için değişkenler
const images = [
  "https://images.unsplash.com/photo-1517420879524-86d64ac2f339?w=1200",
  "https://images.unsplash.com/photo-1503792501406-2c40da09e1e2?w=1200"
];
let currentImageIndex = 0;
let currentScale = 1;
let startScale = 1;
let currentX = 0;
let currentY = 0;
let startX = 0;
let startY = 0;
let imageStartX = 0;
let imageStartY = 0;
let lastTapTime = 0;

// Elementleri seç
const lightbox = document.getElementById('lightbox');
const lightboxContent = document.querySelector('.lightbox-content');
const lightboxImageContainer = document.querySelector('.lightbox-image-container');
const lightboxImage = document.getElementById('lightboxImage');
const popupImages = document.getElementById('popupImages');
const prevButton = document.getElementById('prevButton');
const nextButton = document.getElementById('nextButton');
const closeButton = document.getElementById('closeButton');

// Pop-up görüntüleri göster/gizle
function togglePopupImages(show) {
  popupImages.style.display = show ? 'flex' : 'none';
}

// Lightbox'ı göster
function showLightbox(index) {
  currentImageIndex = index;
  lightboxImage.src = images[currentImageIndex];
  lightbox.style.display = 'flex';
  resetZoom();
  popupImages.style.display = 'none';
}

// Lightbox'ı gizle
function hideLightbox() {
  lightbox.style.display = 'none';
  resetZoom();
  if(opened) {
    popupImages.style.display = 'flex';
  }
}

// Zoom'u sıfırla
function resetZoom() {
  currentScale = 1;
  currentX = 0;
  currentY = 0;
  updateImageTransform();
}

// Görüntü dönüşümünü güncelle
function updateImageTransform() {
  requestAnimationFrame(() => {
    lightboxImage.style.transform = `translate(${currentX}px, ${currentY}px) scale(${currentScale})`;
  });
}

// İki nokta arası mesafe
function getDistance(touch1, touch2) {
  return Math.hypot(
    touch2.clientX - touch1.clientX,
    touch2.clientY - touch1.clientY
  );
}

// İki nokta arası orta nokta
function getMidpoint(touch1, touch2) {
  return {
    x: (touch1.clientX + touch2.clientX) / 2,
    y: (touch1.clientY + touch2.clientY) / 2
  };
}

// Sınırları kontrol et
function checkBounds() {
  const rect = lightboxImage.getBoundingClientRect();
  const containerRect = lightboxImageContainer.getBoundingClientRect();
  
  const maxX = (rect.width * currentScale - containerRect.width) / 2;
  const maxY = (rect.height * currentScale - containerRect.height) / 2;
  
  if (currentScale <= 1) {
    currentX = 0;
    currentY = 0;
  } else {
    currentX = Math.min(Math.max(currentX, -maxX), maxX);
    currentY = Math.min(Math.max(currentY, -maxY), maxY);
  }
  
  updateImageTransform();
}

// Event listeners
popupImages.querySelectorAll('.popup-image').forEach(img => {
  img.addEventListener('click', () => {
    showLightbox(parseInt(img.dataset.index));
  });
});

// Çift tıklama ile zoom
lightboxImage.addEventListener('click', (e) => {
  const now = Date.now();
  if (now - lastTapTime < 300) { // Çift tıklama
    e.preventDefault();
    if (currentScale === 1) {
      const rect = lightboxImage.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      
      currentScale = 2;
      currentX = (rect.width / 2 - x) * (currentScale - 1);
      currentY = (rect.height / 2 - y) * (currentScale - 1);
    } else {
      resetZoom();
    }
    updateImageTransform();
  }
  lastTapTime = now;
});

// Dokunmatik kontroller
lightboxImageContainer.addEventListener('touchstart', (e) => {
  if (e.touches.length === 2) {
    e.preventDefault();
    startScale = currentScale;
    const dist = getDistance(e.touches[0], e.touches[1]);
    imageStartX = currentX;
    imageStartY = currentY;
    startX = dist;
    const midpoint = getMidpoint(e.touches[0], e.touches[1]);
    startY = midpoint;
  } else if (e.touches.length === 1) {
    imageStartX = currentX;
    imageStartY = currentY;
    startX = e.touches[0].clientX;
    startY = e.touches[0].clientY;
  }
}, { passive: false });

lightboxImageContainer.addEventListener('touchmove', (e) => {
  e.preventDefault();
  if (e.touches.length === 2) {
    // Yakınlaştırma/uzaklaştırma
    const dist = getDistance(e.touches[0], e.touches[1]);
    const midpoint = getMidpoint(e.touches[0], e.touches[1]);
    
    currentScale = Math.min(Math.max(startScale * (dist / startX), 1), 5);
    
    if (currentScale > 1) {
      const dragX = midpoint.x - startY.x;
      const dragY = midpoint.y - startY.y;
      currentX = imageStartX + dragX;
      currentY = imageStartY + dragY;
    }
    
    checkBounds();
  } else if (e.touches.length === 1 && currentScale > 1) {
    // Kaydırma
    const dragX = e.touches[0].clientX - startX;
    const dragY = e.touches[0].clientY - startY;
    currentX = imageStartX + dragX;
    currentY = imageStartY + dragY;
    
    checkBounds();
  }
}, { passive: false });

lightboxImageContainer.addEventListener('touchend', (e) => {
  if (e.touches.length === 0) {
    if (currentScale <= 1) {
      resetZoom();
    } else {
      checkBounds();
    }
  }
});

closeButton.addEventListener('click', hideLightbox);

prevButton.addEventListener('click', (e) => {
  e.stopPropagation();
  currentImageIndex = (currentImageIndex - 1 + images.length) % images.length;
  lightboxImage.src = images[currentImageIndex];
  resetZoom();
});

nextButton.addEventListener('click', (e) => {
  e.stopPropagation();
  currentImageIndex = (currentImageIndex + 1) % images.length;
  lightboxImage.src = images[currentImageIndex];
  resetZoom();
});

// Klavye kontrolü
document.addEventListener('keydown', (e) => {
  if (lightbox.style.display === 'flex') {
    if (e.key === 'ArrowLeft') {
      prevButton.click();
    } else if (e.key === 'ArrowRight') {
      nextButton.click();
    } else if (e.key === 'Escape') {
      hideLightbox();
    }
  }
});
</script>
</body>
</html>
